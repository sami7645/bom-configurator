{% extends 'base.html' %}
{% load static %}

{% block title %}BOM Konfigurator{% endblock %}

{% block extra_css %}
<style>
    .step-indicator {
        counter-reset: step-counter;
    }
    
    .step-indicator .step {
        counter-increment: step-counter;
    }
    
    .step-indicator .step::before {
        content: counter(step-counter);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Progress Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="progress-steps step-indicator">
                <div class="step active" id="step-1"></div>
                <div class="step" id="step-2"></div>
                <div class="step" id="step-3"></div>
                <div class="step" id="step-4"></div>
                <div class="step" id="step-5"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <small class="text-muted">Schachttyp</small>
                <small class="text-muted">HVB & Sonden</small>
                <small class="text-muted">Konfiguration</small>
                <small class="text-muted">Pr√ºfung</small>
                <small class="text-muted">BOM</small>
            </div>
        </div>
    </div>

    <form id="bomConfigForm">
        {% csrf_token %}
        
        <!-- Step 1: Basic Configuration -->
        <div class="config-step" id="config-step-1">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-layer-group me-2"></i>Schritt 1: Grundkonfiguration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="configName" class="form-label">Konfigurationsname</label>
                                    <input type="text" class="form-control" id="configName" name="configuration_name" 
                                           placeholder="z.B. Projekt ABC - Konfiguration 1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="schachttyp" class="form-label">Schachttyp</label>
                                    <select class="form-select" id="schachttyp" name="schachttyp" required>
                                        <option value="">Bitte w√§hlen...</option>
                                        {% for schacht in schacht_types %}
                                            <option value="{{ schacht.schachttyp }}">{{ schacht.schachttyp }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="hvbSize" class="form-label">HVB-Gr√∂√üe (mm)</label>
                                    <select class="form-select" id="hvbSize" name="hvb_size" required>
                                        <option value="">Bitte w√§hlen...</option>
                                        {% for hvb in hvb_sizes %}
                                            <option value="{{ hvb.hauptverteilerbalken }}">{{ hvb.hauptverteilerbalken }}mm</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="wpDiameter" class="form-label">WP-Durchmesser (optional)</label>
                                    <select class="form-select" id="wpDiameter" name="wp_diameter">
                                        <option value="">Keinen ausw√§hlen</option>
                                    </select>
                                    <div class="form-text">
                                        <span id="wpDiameterHint"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                    Weiter <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Probe Configuration -->
        <div class="config-step d-none" id="config-step-2">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-ruler me-2"></i>Schritt 2: Sonden-Konfiguration</h5>
                        </div>
                        <div class="card-body">
                            <!-- Previous Steps Summary -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="summary-section">
                                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Schritt 1:</h6>
                                        <div class="step-1-summary"></div>
                                    </div>
                                </div>
                            </div>
                            <hr class="mb-4">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="anschlussart" class="form-label">Anschlussart</label>
                                    <select class="form-select" id="anschlussart" name="anschlussart" required>
                                        <option value="">Bitte w√§hlen...</option>
                                        <option value="einseitig">Einseitig</option>
                                        <option value="beidseitig">Beidseitig</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="sondenDurchmesser" class="form-label">Sonden-Durchmesser</label>
                                    <select class="form-select" id="sondenDurchmesser" name="sonden_durchmesser" required>
                                        <option value="">Erst Schachttyp und HVB w√§hlen...</option>
                                    </select>
                                    {% comment %} <button type="button" class="btn btn-sm btn-secondary mt-1" onclick="testSondenAPI()">üîß Test API</button> {% endcomment %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sondenanzahl" class="form-label">Anzahl Sonden</label>
                                    <input type="number" class="form-control" id="sondenanzahl" name="sondenanzahl" 
                                           min="1" max="100" value="2" required>
                                    <div class="form-text">
                                        <span id="sondenanzahlRange"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sondenabstand" class="form-label">Sondenabstand (mm)</label>
                                    <select class="form-select" id="sondenabstand" name="sondenabstand" required>
                                        <option value="">Erst Anschlussart w√§hlen...</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="bauform" class="form-label">Bauform</label>
                                    <select class="form-select" id="bauform" name="bauform">
                                        <option value="I">I-Form (einseitig)</option>
                                        <option value="U">U-Form (beidseitig)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Zuschl√§ge</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="number" class="form-control" id="zuschlagLinks" 
                                                   name="zuschlag_links" placeholder="Links (mm)" value="100">
                                        </div>
                                        <div class="col-6">
                                            <input type="number" class="form-control" id="zuschlagRechts" 
                                                   name="zuschlag_rechts" placeholder="Rechts (mm)" value="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vorlauf / R√ºcklauf L√§ngen pro Sonde (optional) -->
                            <div class="row mt-2">
                                <div class="col-md-6 mb-3">
                                    <label for="vorlauflengthperprobe" class="form-label">Vorlauf-L√§nge pro Sonde (m, optional)</label>
                                    <input type="number" step="0.001" min="0" class="form-control" id="vorlauflengthperprobe" name="vorlauf_length_per_probe" placeholder="z.B. 0.245">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="ruecklauflengthperprobe" class="form-label">R√ºcklauf-L√§nge pro Sonde (m, optional)</label>
                                    <input type="number" step="0.001" min="0" class="form-control" id="ruecklauflengthperprobe" name="ruecklauf_length_per_probe" placeholder="z.B. 0.145">
                                </div>
                            </div>
                            
                            <!-- HVB L√§ngenberechnung (Blaue Sektion) -->
                            <div class="row mt-4">
                                <div class="col-12 mb-3">
                                    <div class="card border-0 shadow-sm" style="background-color: var(--gnv-primary-blue); color: white;">
                                        <div class="card-body text-center py-4">
                                            <h2 class="mb-2" id="hvbLengthDisplay" style="font-size: 2.5rem; font-weight: bold; color: white;">‚Äì</h2>
                                            <p class="mb-1" style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.95);">HVB L√§ngenberechnung</p>
                                            <p class="mb-0" style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.9);" id="hvbLengthFormula">Bitte alle Werte eingeben...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Informational Note (U-Form) -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-center mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small>U-Form Konfiguration: Bei ungleichm√§√üiger Sondenverteilung verwendet das System die gleiche Formel, als w√§ren die Sonden gleichm√§√üig auf beiden Seiten verteilt, f√ºr das ERP-System.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- HVB St√ºtze Articles Section -->
                            <div class="row mt-4 d-none" id="hvbStuetzeSection">
                                <div class="col-12">
                                    <div class="card border-light shadow-sm">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-cube me-2"></i>HVB St√ºtze</h6>
                                            <small style="color: rgba(255, 255, 255, 0.9) !important;">Artikel f√ºr die gew√§hlte HVB-Gr√∂√üe. Sie k√∂nnen die Mengen anpassen.</small>
                                        </div>
                                        <div class="card-body">
                                            <div id="hvbStuetzeArticlesList">
                                                <p class="text-muted text-center mb-0">Bitte HVB-Gr√∂√üe in Schritt 1 w√§hlen...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="previousStep(1)">
                                    <i class="fas fa-arrow-left me-2"></i>Zur√ºck
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                                    Weiter <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Additional Components -->
        <div class="config-step d-none" id="config-step-3">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-plus-circle me-2"></i>Schritt 3: Zus√§tzliche Komponenten</h5>
                        </div>
                        <div class="card-body">
                            <!-- Previous Steps Summary -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="summary-section">
                                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Schritt 1:</h6>
                                        <div class="step-1-summary"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="summary-section">
                                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Schritt 2:</h6>
                                        <div class="step-2-summary"></div>
                                    </div>
                                </div>
                            </div>
                            <hr class="mb-4">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6 class="mb-3" style="color: #dc3545; font-weight: 600;">Vorlauf</h6>
                                    <div class="mb-3">
                                        <label for="kugelhahnType" class="form-label">Kugelhahn-Typ (optional)</label>
                                        <select class="form-select" id="kugelhahnType" name="kugelhahn_type">
                                            <option value="">Keinen ausw√§hlen</option>
                                            {% for kugelhahn in kugelhahn_types %}
                                                <option value="{{ kugelhahn.kugelhahn }}">{{ kugelhahn.kugelhahn }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dfmType" class="form-label">Durchflussmesser-Typ</label>
                                        <select class="form-select" id="dfmType" name="dfm_type" disabled>
                                            <option value="">Erst Kategorie w√§hlen...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6 class="mb-3" style="color: #6f42c1; font-weight: 600;">R√ºcklauf</h6>
                                    <div class="mb-3">
                                        <label for="dfmCategory" class="form-label">Durchflussmesser-Kategorie (optional)</label>
                                        <select class="form-select" id="dfmCategory" name="dfm_category">
                                            <option value="">Keinen ausw√§hlen</option>
                                            <option value="plastic">Kunststoff-Durchflussmesser</option>
                                            <option value="brass">Messing-Durchflussmesser</option>
                                            <option value="kugelhahn">Kugelhahn-Typ</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="dfmKugelhahnTypeSection" style="display: none;">
                                        <label for="dfmKugelhahnType" class="form-label">D-Kugelhahn-Typ</label>
                                        <select class="form-select" id="dfmKugelhahnType" name="dfm_kugelhahn_type">
                                            <option value="">Bitte w√§hlen...</option>
                                            {% for kugelhahn in kugelhahn_types %}
                                                <option value="{{ kugelhahn.kugelhahn }}">{{ kugelhahn.kugelhahn }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- GN X Chamber Articles (will be shown dynamically) -->
                            <div id="gnxChamberSection" class="d-none">
                                <hr>
                                <h6><i class="fas fa-cube me-2"></i>GN X Kammer - Zusatzartikel</h6>
                                <p class="text-muted">
                                    Basierend auf der HVB-Gr√∂√üe werden automatisch passende Artikel ausgew√§hlt. 
                                    Sie k√∂nnen die Mengen anpassen.
                                </p>
                                <div id="gnxArticlesList"></div>
                            </div>
                            
                            <div class="text-end">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="previousStep(2)">
                                    <i class="fas fa-arrow-left me-2"></i>Zur√ºck
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep(4)">
                                    Weiter <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Configuration Check -->
        <div class="config-step d-none" id="config-step-4">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-search me-2"></i>Schritt 4: Konfiguration pr√ºfen</h5>
                        </div>
                        <div class="card-body">
                            <!-- Previous Steps Summary -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="summary-section">
                                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Schritt 1:</h6>
                                        <div class="step-1-summary"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="summary-section">
                                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Schritt 2:</h6>
                                        <div class="step-2-summary"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="summary-section">
                                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Schritt 3:</h6>
                                        <div class="step-3-summary"></div>
                                    </div>
                                </div>
                            </div>
                            <hr class="mb-4">
                            
                            <div id="configurationCheck">
                                <div class="text-center">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-2">Pr√ºfe Konfiguration...</p>
                                </div>
                            </div>
                            
                            <div id="articleNumberSection" class="d-none">
                                <hr>
                                <h6>Artikelnummer-Verwaltung</h6>
                                <div id="articleNumberContent"></div>
                            </div>
                            
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button type="button" class="btn btn-outline-secondary" onclick="previousStep(3)">
                                    <i class="fas fa-arrow-left me-2"></i>Zur√ºck
                                </button>
                                <button type="button" class="btn btn-success" id="generateBomBtn" onclick="generateBOM()" disabled>
                                    <i class="fas fa-magic me-2"></i>BOM generieren
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: BOM Result -->
        <div class="config-step d-none" id="config-step-5">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-list-alt me-2"></i>Schritt 5: Generierte BOM</h5>
                        </div>
                        <div class="card-body">
                            <div id="bomResult">
                                <div class="text-center">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-2">Generiere BOM...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/configurator.js' %}?v=2"></script>
{% endblock %}
